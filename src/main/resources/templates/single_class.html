<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" >
    <title th:text="${currentSchoolClass.className} + ' - ' + ${currentSchoolClass.subject}"></title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script th:src="@{/js/actions.js}"></script>
    <link th:href="@{/css/styles.css}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

</head>
<body>
    <section>
        <button onclick="goBackLevels(2)">zurück</button>
        <h1 th:data-id="${currentSchoolClass.Id}" th:data-classname="${currentSchoolClass.className}" th:data-subject="${currentSchoolClass.subject}" th:text="${currentSchoolClass.className} + ' - ' + ${currentSchoolClass.subject}"></h1>
        <button onclick="openSchoolClassEdit()">Name / Fach ändern</button>
        <div id="editSchoolClass" th:data-id="${currentSchoolClass.Id}">
            <label for="">Klasse:</label>
            <input type="text" class="className" id="className" onchange="updateSchoolClass(this)">
            <label for="">Fach:</label>
            <input type="text" class="classSubject" id="classSubject" onchange="updateSchoolClass(this)">
        </div>
    </section>
    <section id="overview">
        <div>
            <p th:text="'Schüler: ' + ${#lists.size(currentSchoolClass.students)}">Schüler: 14</p>
            <th:block>
                <p>
                    <th:block th:text="'Gewichtung (schriftlich/mündlich): '"></th:block>
                    <th:block th:text="${currentSchoolClass.writtenWeighting} ?: 'x'"></th:block>
                    <th:block th:text="' : '"></th:block>
                    <th:block th:text="${currentSchoolClass.oralWeighting} ?: 'x'"></th:block>
                </p>
            </th:block>
            <p>Noten</p>
            <ul>
                <p th:text="'schriftlich: ' + ${#lists.size(writtenGradeTests)}">schriftlich: 2</p>
                <p th:text="'mündlich: ' + ${#lists.size(oralGradeTests)}">mündlich: 1</p>
            </ul>

        </div>
        <div>
            <button onclick="window.location.href=window.location.href + '/students'">Schüler bearbeiten</button><br/>
            <button onclick="showHelperContent()">Note anlegen</button><br>
            <button onclick="showWeightings()">Gewichtung ändern</button>
        </div>
        <div id="helpercontent">
            <h3>Neue Note</h3>
            <form method="POST" th:action="@{/schoolclasses/{id}/newgradetest(id=${currentSchoolClass.Id})}" th:object="${newGradeTest}">
                <input type="radio" th:field="*{gradeType}" id="written" name="grade_type" value="WRITTEN">
                <label for="written">schriftlich</label>
                <input type="radio" th:field="*{gradeType}" id="oral" name="grade_type" value="ORAL">
                <label for="oral">mündlich</label><br>

                <label for="">Name:</label>
                <input type="text" th:field="*{testName}"><br>
                <label for="">Beschreibung:</label>
                <input type="text" th:field="*{testDescription}"><br>
                <input type="submit" value="anlegen">
            </form>
        </div>
    </section>

    <section>
        <table id="main" class="table">
            <thead>
                <tr>
                    <th rowspan="3">#</th>
                    <th rowspan="3">Vorname</th>
                    <th rowspan="3">Nachname</th>
                    <th th:unless="${#lists.isEmpty(writtenGradeTests)}" th:colspan="${#lists.size(writtenGradeTests)}">
                        <th:block th:text="'schrifliche Noten '"></th:block>
                        <span id="writtenweightingsdisplay">
                            <th:block th:text="'('"></th:block>
                                <th:block th:each="gradeTest, iterStat : ${writtenGradeTests}">
                                <th:block th:text="${gradeTest.weighting} ?: 'x'"></th:block>
                                <th:block th:unless="${iterStat.count} == ${#lists.size(writtenGradeTests)}" th:text="':'"></th:block>
                            </th:block>

                            <th:block th:text="')'"></th:block>
                        </span>
                    </th>
                    <th th:unless="${#lists.isEmpty(oralGradeTests)}" th:colspan="${#lists.size(oralGradeTests)}">
                        <th:block th:text="'mündliche Noten '"></th:block>
                        <span id="oralweightingsdisplay">
                            <th:block th:text="'('"></th:block>
                                <th:block th:each="gradeTest, iterStat : ${oralGradeTests}">
                                <th:block th:text="${gradeTest.weighting} ?: 'x'"></th:block>
                                <th:block th:unless="${iterStat.count} == ${#lists.size(oralGradeTests)}" th:text="':'"></th:block>
                            </th:block>
                            <th:block th:text="')'"></th:block>
                        </span>
                    </th>
                    <th colspan="3">Durchschnitte</th>
                </tr>
                <tr>
                    <th th:unless="${#lists.isEmpty(writtenGradeTests)}" th:each="gradeTest : ${writtenGradeTests}"
                        th:onclick="'openGradeTest(' + ${gradeTest.Id} + ')'" class="clickable" th:data-id="${gradeTest.Id}"
                        title="Noten eintragen"
                        th:text="${gradeTest.testName}"></th>
                    <th th:unless="${#lists.isEmpty(oralGradeTests)}" th:each="gradeTest : ${oralGradeTests}"
                        th:onclick="'openGradeTest(' + ${gradeTest.Id} + ')'" class="clickable" th:data-id="${gradeTest.Id}"
                        title="Noten eintragen" th:text="${gradeTest.testName}"></th>
                    <th rowspan="2" >schriftlich</th>
                    <th rowspan="2">mündlich</th>
                    <th:block>
                        <th rowspan="2">
                            <th:block th:text="'Gesamt ('"></th:block>
                            <th:block th:text="${currentSchoolClass.writtenWeighting} ?: 'x'"></th:block>
                            <th:block th:text="' : '"></th:block>
                            <th:block th:text="${currentSchoolClass.oralWeighting} ?: 'x'"></th:block>
                            <th:block th:text="')'"></th:block>
                        </th>
                    </th:block>
                </tr>
                <tr>
                    <th th:unless="${#lists.isEmpty(writtenGradeTests)}" th:each="gradeTest : ${writtenGradeTests}"
                        th:onclick="'openGradeTest(' + ${gradeTest.Id} + ')'" class="clickable desc" th:data-id="${gradeTest.Id}"
                        title="Noten eintragen" th:text="${gradeTest.testDescription}"></th>
                    <th th:unless="${#lists.isEmpty(oralGradeTests)}" th:each="gradeTest : ${oralGradeTests}"
                        th:onclick="'openGradeTest(' + ${gradeTest.Id} + ')'" class="clickable desc" th:data-id="${gradeTest.Id}"
                        title="Noten eintragen" th:text="${gradeTest.testDescription}"></th>
                </tr>

            </thead>

            <tbody>
                <tr th:unless="${#lists.isEmpty(studentavg)}" th:each="student, iterStat : ${studentavg}">
                    <td th:text="${iterStat.count}"></td>
                    <td th:text="${student.firstName}"></td>
                    <td th:text="${student.lastName}"></td>
<!--                    <td class="grade" th:each="grade : ${student.grades}" th:text="${grade.Grade}"></td>-->
                    <td class="grade" th:each="grade : ${student.writtenGrades}" th:text="${grade.Grade}"></td>
                    <td class="grade" th:each="grade : ${student.oralGrades}" th:text="${grade.Grade}"></td>
                    <td th:text="${#numbers.formatDecimal(student.writtenAverage,1,2,'COMMA')} ?: '-'"></td>
                    <td th:text="${#numbers.formatDecimal(student.oralAverage,1,2,'COMMA')} ?: '-'"></td>
                    <td th:text="${#numbers.formatDecimal(student.totalAverage,1,2,'COMMA')} ?: '-'"></td>
                </tr>
                <tr>
                    <td><button id="plusbutton" onclick="openNewStudentWindow()">+</button></td>
                    <td class="input"><input type="text" id="firstName"></td>
                    <td class="input"><input type="text" id="lastName"></td>
                    <td><button id="createbutton" onclick="createNewStudent()">anlegen</button></td>

                </tr>
                <tr>
                    <td class="emptycell" colspan="3"></td>
                    <th:block th:unless="${#lists.isEmpty(writtenGradeTests)}" th:each="gradeTest : ${writtenGradeTests}">
                        <th:block th:switch="${#arrays.contains(gradeTest.grades.![grade], null)}">
                            <td th:case="true" class="avgdisplay" th:text="'&#8709; -'"></td>
                            <td th:case="false" class="avgdisplay" th:text="'&#8709; ' + ${#numbers.formatDecimal(#aggregates.avg(gradeTest.grades.![grade]),1,2,'COMMA')}"></td>
                        </th:block>
                    </th:block>
                    <th:block th:unless="${#lists.isEmpty(oralGradeTests)}" th:each="gradeTest : ${oralGradeTests}">
                        <th:block th:unless="${#arrays.contains(gradeTest.grades.![grade], null)}">
                            <td class="avgdisplay" th:text="'&#8709; ' + ${#numbers.formatDecimal(#aggregates.avg(gradeTest.grades.![grade]),1,2,'COMMA')}">
                            </td>
                        </th:block>
                    </th:block>
                </tr>
            </tbody>
        </table>

        <span id="weightingswarning"> - : fehlende Gewichtung / fehlende Noten</span>
    </section>

<script>
$("th.clickable").hover(function() {
    $(this).addClass("coloredHeader");
    var i = $(this).index();
    var nextElem = $(this).closest("tr").next().children().eq(i);
    var prevElem =$(this).closest("tr").prev().children().eq(i)
    if( nextElem.is("th.clickable")) {
        nextElem.addClass("coloredHeader");
    }
    if( prevElem.is("th.clickable")) {
       prevElem.addClass("coloredHeader");
    }
    }, function() {
    $(this).removeClass("coloredHeader");
    var i = $(this).index();
    $(this).closest("tr").next().children().eq(i).removeClass("coloredHeader");
    $(this).closest("tr").prev().children().eq(i).removeClass("coloredHeader");
});
</script>
</body>
</html>